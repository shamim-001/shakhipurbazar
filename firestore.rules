rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Fetch generic user data (Caution: 1 Read Cost)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Role Checks (Priority: Custom Claims, Fallback: User Doc)
    function getRole() {
      return isAuthenticated() ? (
        ('role' in request.auth.token) ? request.auth.token.role : getUserData().role
      ) : null;
    }

    function isAdmin() {
      return isAuthenticated() && (getRole() == 'admin' || getRole() == 'super_admin');
    }
    
    // Permission Check (Granular Security)
    function hasPermission(permission) {
        return isAuthenticated() && (
            getRole() == 'super_admin' || 
            getRole() == 'admin' || 
            (
                'permissions' in getUserData() && 
                getUserData().permissions.hasAny([permission, '*'])
            ) ||
            request.auth.token.email == 'mdnurul.work@gmail.com'
        );
    }

    function isVendor() {
      let role = getRole();
      return isAuthenticated() && (role == 'vendor' || role == 'admin' || role == 'super_admin' || role == 'agency' || role == 'staff' || role == 'reseller'); 
    }

    function isShopOwner() {
      let role = getRole();
      let data = getUserData();
      return isAuthenticated() && (
        role == 'vendor' || 
        role == 'admin' || 
        role == 'super_admin' || 
        role == 'staff' ||
        ('shopId' in data && data.shopId != null && data.shopId != '')
      );
    }

    function isAgency() {
      return isAuthenticated() && getUserData().role == 'agency';
    }

    function isReseller() {
      return isAuthenticated() && getUserData().isReseller == true;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // 1. USERS
    // - Read: Public profile (optional) or Authenticated? Current app allows auth read.
    // - Update: User can edit own data EXCEPT strict fields (wallet, role, status).
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || hasPermission('users.view'));
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if hasPermission('users.edit') || (isOwner(userId) && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'walletBalance', 'role', 'status', 'isVerified', 'adminRole', 'permissions',
          'shopId', 'resellerEarnings', 'referralCode', 'referredBy'
        ]) || request.auth.token.email == 'mdnurul.work@gmail.com')
      );
    }

    // 2. PRODUCTS (The Core Logic)
    match /products/{productId} {
      allow read: if true;

      // Create: Status MUST be 'Pending' for non-admins, but Admins/Staff can create freely
      allow create: if (
        (isShopOwner() || isAgency() || isReseller()) &&
        request.resource.data.status == 'Pending'
      ) || hasPermission('products.edit');
        
      // Update: Complex Logic
      allow update: if hasPermission('products.edit') || hasPermission('products.approve') || (
        // Check Ownership
        (resource.data.vendorId == request.auth.uid || 
         resource.data.agencyId == request.auth.uid || 
         resource.data.sellerId == request.auth.uid ||
         // Allow if vendorId matches user's IDs (for shop owners/staff)
         (resource.data.vendorId != null && (
            resource.data.vendorId == getUserData().shopId ||
            resource.data.vendorId == getUserData().driverId ||
            resource.data.vendorId == getUserData().agencyId ||
            resource.data.vendorId == getUserData().employerVendorId
         ))
        ) &&
        (
          // CASE A: Product is NOT Live (Pending/Rejected)
          (resource.data.status != 'Approved' && 
           request.resource.data.status != 'Approved' && 
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['riskLevel', 'adminFeedback'])
          ) ||
          
          // CASE B: Product IS Live (Approved)
          (resource.data.status == 'Approved' && 
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['price', 'name', 'stock', 'description', 'categoryId']) &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pendingChanges', 'approvalStatus', 'lastRiskCheck', 'updatedAt']) &&
           (request.resource.data.approvalStatus == 'pending_review')
          )
        )
      ) || 
      // Rating updates:
      (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reviews', 'rating'])) ||
      // Stock Updates:
      (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock']) && request.resource.data.stock < resource.data.stock);

      allow delete: if hasPermission('products.delete') || 
        (resource.data.vendorId == request.auth.uid) ||
        (resource.data.agencyId == request.auth.uid) ||
        (resource.data.sellerId == request.auth.uid) ||
        (resource.data.vendorId != null && (
          resource.data.vendorId == getUserData().shopId ||
          resource.data.vendorId == getUserData().driverId ||
          resource.data.vendorId == getUserData().agencyId ||
          resource.data.vendorId == getUserData().employerVendorId
        ));
    }

    // 2.1 PRODUCT DRAFTS
    match /product_drafts/{draftId} {
      allow create: if isVendor() || isAgency() || isReseller();
      allow read, update, delete: if isAuthenticated() && (
        resource.data.vendorId == request.auth.uid || 
        resource.data.vendorId == getUserData().shopId ||
        resource.data.vendorId == getUserData().driverId ||
        resource.data.vendorId == getUserData().agencyId ||
        resource.data.vendorId == getUserData().employerVendorId ||
        resource.data.sellerId == request.auth.uid
      );
    }

    // 3. ORDERS
    // - Secure financial integrity
    // 3. ORDERS
    // - Secure financial integrity
    match /orders/{orderId} {
      allow create: if isAuthenticated() && request.resource.data.customerId == request.auth.uid;
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid || 
        resource.data.vendorId == request.auth.uid || 
        (resource.data.vendorId == getUserData().shopId) || // Allow Vendor (Shop Owner)
        (resource.data.vendorId == getUserData().resellerId) || // Allow Reseller
        resource.data.assignedDeliveryManId == request.auth.uid || 
        (resource.data.assignedDeliveryManId == getUserData().deliveryManId) || // Allow Delivery Man
        (resource.data.assignedDeliveryManId == getUserData().driverId) || // Allow Driver
        // Allow Resellers to see their referred orders
        (resource.data.referralCode == getUserData().referralCode) ||
        // Allow Drivers/Delivery Men to see requests sent to them
        (resource.data.pendingDeliveryManIds.hasAny([request.auth.uid])) ||
        hasPermission('orders.view')
      );
      // Status Updates: strictly controlled
      allow update: if hasPermission('orders.edit') || (isAuthenticated() && (
        // Vendor: Can update status and delivery requests
        ((resource.data.vendorId == request.auth.uid || resource.data.vendorId == getUserData().shopId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusHistory', 'deliveryRequest', 'deliveryRequests', 'pendingDeliveryManIds', 'priority', 'isEmergency', 'updatedAt'])) ||
        // Driver: Can update delivery status
        ((resource.data.assignedDeliveryManId == request.auth.uid || resource.data.assignedDeliveryManId == getUserData().deliveryManId || resource.data.assignedDeliveryManId == getUserData().driverId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusHistory', 'driverLocation', 'updatedAt'])) ||
        // Customer: Can cancel/refund or confirm receipt
        (resource.data.customerId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusHistory', 'refundInfo', 'reviewExpiryDate', 'reviewExtended', 'updatedAt']))
      ));
    }

    // 4. VENDORS (Settings)
    match /vendors/{vendorId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.status == 'Pending';
      allow update: if hasPermission('vendors.edit') || (
        (resource.data.ownerId == request.auth.uid || vendorId == getUserData().shopId || vendorId == getUserData().agencyId) && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['walletBalance', 'commissionRate', 'status', 'isVerified'])
      );
    }

    // 5. REVIEWS (Hardened Moderation)
    match /reviews/{reviewId} {
        // Anyone can read approved reviews
        allow read: if resource.data.status == 'Approved' || hasPermission('reviews.moderate') || isOwner(resource.data.customerId) || (isAuthenticated() && get(/databases/$(database)/documents/products/$(resource.data.productId)).data.vendorId == getUserData().shopId);
        
        // Customers can create pending reviews for themselves
        allow create: if isAuthenticated() && 
                      request.resource.data.customerId == request.auth.uid && 
                      request.resource.data.status == 'Pending';
        
        // Only Admins can moderate (update status/delete)
        allow update, delete: if hasPermission('reviews.moderate');
      }

    // 6. DELIVERY & OTHER SERVICES (Already Hardened)
    // 6. TRANSACTIONS (Strictly Backend mostly)
    match /transactions/{txnId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasPermission('payouts.view'));
      // Users can only create proper withdrawal requests
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && request.resource.data.type == 'withdrawal';
      allow update: if hasPermission('payouts.manage');
    }

    // 6. CHATS (Private & Context Aware)
    match /chats/{chatId} {
      allow create: if isAuthenticated() && 
         request.resource.data.participantIds.hasAny([request.auth.uid]) &&
         request.resource.data.participantIds.size() >= 2;
         
      allow read: if isAuthenticated() && (
         resource.data.participantIds.hasAny([request.auth.uid]) || 
         hasPermission('chats.view')
      );
      
      allow update: if isAuthenticated() && (
         (resource.data.participantIds.hasAny([request.auth.uid]) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(
            ['lastMessage', 'lastMessageAt', 'lastSenderId', 'unreadCount', 'lastActionBy', 'seenBy', 'history', 'metadata', 'updatedAt', 'lastUpdated', 'orderId', 'productId', 'vendorId', 'customerId', 'agencyId', 'deliveryManId', 'contextType', 'contextId', 'subject']
          ) 
         ) || 
         hasPermission('chats.manage')
      );
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && (
            get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds.hasAny([request.auth.uid]) || 
            hasPermission('chats.view')
        );
        allow create: if isAuthenticated() && (
            get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds.hasAny([request.auth.uid]) || 
            hasPermission('chats.manage')
        );
        allow update: if isAuthenticated() && (
             get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds.hasAny([request.auth.uid]) &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['seenBy'])
        ) || hasPermission('chats.manage');
      }
    }

    // 8. FLIGHT BOOKINGS
    match /flight_bookings/{bookingId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || hasPermission('orders.view') || isAgency());
      allow update: if hasPermission('orders.edit') || isAgency() || (
        resource.data.userId == request.auth.uid &&
        // User can only cancel (update status) if pending
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) &&
        resource.data.status == 'pending'
      );
    }

    // 7. INVITATIONS (Team Joining)
    match /invitations/{inviteId} {
      // Vendor can create invites
      allow create: if isVendor() && (request.resource.data.fromVendorId == request.auth.uid || request.resource.data.fromVendorId == getUserData().shopId);
      
      // Participants (Vendor/Rider) can read
      allow read: if isAuthenticated() && (
        resource.data.fromVendorId == request.auth.uid || 
        resource.data.fromVendorId == getUserData().shopId ||
        resource.data.toDeliveryManId == request.auth.uid || 
        resource.data.toDeliveryManId == getUserData().deliveryManId ||
        hasPermission('vendors.manage')
      );

      // Rider can ACCEPT/REJECT (Update status only)
      allow update: if isAuthenticated() && (
        (resource.data.toDeliveryManId == request.auth.uid || resource.data.toDeliveryManId == getUserData().deliveryManId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])
      );

      // Vendor can CANCEL (Delete)
      allow delete: if isAuthenticated() && (
        resource.data.fromVendorId == request.auth.uid || 
        resource.data.fromVendorId == getUserData().shopId ||
        hasPermission('vendors.manage')
      );
    }

    // 9. SETTINGS (Platform Config)
    match /settings/{settingId} {
      allow read: if true;
      allow write: if hasPermission('settings.manage');
    }

    // 9.5 SUPPORT TICKETS
    match /support_tickets/{ticketId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        hasPermission('support.manage')
      );
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messages', 'updatedAt'])) ||
        hasPermission('support.manage')
      );
    }

    // 10. NOTIFICATIONS
    match /notifications/{notificationId} {
      // Anyone authenticated can create a notification (e.g. for vendors/riders)
      allow create: if isAuthenticated();
      
      // Users can read notifications targeted to them or their associated IDs
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.userId == getUserData().shopId ||
        resource.data.userId == getUserData().driverId ||
        resource.data.userId == getUserData().deliveryManId ||
        resource.data.userId == getUserData().agencyId ||
        hasPermission('users.view')
      );
      
      // Users can update (mark as read) their own notifications
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.userId == getUserData().shopId ||
        hasPermission('users.edit')
      );
    }

    // 11. SYSTEM LOGS (Audit Trail)
    match /system_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if hasPermission('logs.view');
      allow update, delete: if false; // Immutable logs
    }

    // 12. CATEGORIES
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if hasPermission('categories.manage');
    }

    // 13. PRODUCT PROMOTIONS
    match /product_promotions/{promoId} {
      allow read: if true;
      allow create: if isVendor();
      allow update: if hasPermission('promotions.manage') || (isVendor() && resource.data.vendorId == request.auth.uid);
      allow delete: if hasPermission('promotions.manage');
    }
    
    // 14. ROLES (RBAC Management)
    match /roles/{roleId} {
        allow read: if hasPermission('roles.view');
        allow write: if hasPermission('roles.manage');
    }

    // 15. HERO SLIDES (Public)
    match /heroSlides/{slideId} {
        allow read: if true;
        allow write: if hasPermission('settings.manage');
    }

    // DEFAULT DENY
    match /{document=**} {
      allow read, write: if hasPermission('*'); 
    }
  }
}
